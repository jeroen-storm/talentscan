<!DOCTYPE html>
<html lang="nl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Firebase Debug - Talent Scan</title>
    <style>
        body {
            font-family: monospace;
            padding: 20px;
            background: #1a1a1a;
            color: #0f0;
        }
        .section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #0f0;
            background: #000;
        }
        .success { color: #0f0; }
        .error { color: #f00; }
        .warning { color: #ff0; }
        .info { color: #0ff; }
        button {
            padding: 10px 20px;
            margin: 5px;
            background: #0f0;
            color: #000;
            border: none;
            cursor: pointer;
            font-weight: bold;
        }
        button:hover {
            background: #0a0;
        }
        pre {
            background: #111;
            padding: 10px;
            overflow: auto;
        }
    </style>
</head>
<body>
    <h1>üîß Firebase Debug Console</h1>
    
    <div class="section">
        <h2>1. Firebase Initialisatie Status</h2>
        <div id="init-status">Checking...</div>
    </div>
    
    <div class="section">
        <h2>2. Database Verbinding</h2>
        <div id="connection-status">Checking...</div>
        <button onclick="testConnection()">Test Connectie</button>
    </div>
    
    <div class="section">
        <h2>3. Database Regels Test</h2>
        <div id="rules-test">Not tested yet</div>
        <button onclick="testWrite()">Test Write</button>
        <button onclick="testRead()">Test Read</button>
    </div>
    
    <div class="section">
        <h2>4. Huidige Statistics</h2>
        <div id="current-stats">Not loaded</div>
        <button onclick="loadStats()">Load Statistics</button>
    </div>
    
    <div class="section">
        <h2>5. Simulate Scan Completion</h2>
        <button onclick="simulateScan()">Simulate Scan & Save</button>
        <div id="simulate-result"></div>
    </div>
    
    <div class="section">
        <h2>6. Console Log</h2>
        <pre id="console-log"></pre>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    
    <script>
        // Log helper
        function log(message, type = 'info') {
            const logDiv = document.getElementById('console-log');
            const timestamp = new Date().toLocaleTimeString();
            logDiv.innerHTML += `<span class="${type}">[${timestamp}] ${message}</span>\n`;
            console.log(message);
        }

        // Firebase config
        const firebaseConfig = {
            apiKey: "AIzaSyA4C-5dWbchpxwBSR3CsBHojGuC31GHets",
            authDomain: "talent-scan-4fed1.firebaseapp.com",
            projectId: "talent-scan-4fed1",
            storageBucket: "talent-scan-4fed1.firebasestorage.app",
            messagingSenderId: "555119008430",
            appId: "1:555119008430:web:28984b3f5df801d772eb3f",
            measurementId: "G-MVZLLNC7MD"
        };

        let db = null;

        // Initialize Firebase
        try {
            log('Initializing Firebase...', 'info');
            firebase.initializeApp(firebaseConfig);
            db = firebase.firestore();
            
            // Enable offline persistence
            db.enablePersistence()
                .catch((err) => {
                    if (err.code == 'failed-precondition') {
                        log('Multiple tabs open, persistence only works in one tab', 'warning');
                    } else if (err.code == 'unimplemented') {
                        log('Browser doesn\'t support persistence', 'warning');
                    }
                });
            
            document.getElementById('init-status').innerHTML = '<span class="success">‚úÖ Firebase initialized successfully!</span>';
            log('Firebase initialized successfully!', 'success');
        } catch (error) {
            document.getElementById('init-status').innerHTML = '<span class="error">‚ùå Error: ' + error.message + '</span>';
            log('Firebase initialization failed: ' + error.message, 'error');
        }

        // Test connection
        async function testConnection() {
            log('Testing connection...', 'info');
            const statusDiv = document.getElementById('connection-status');
            
            try {
                // Try to get server timestamp
                const testDoc = await db.collection('_test').add({
                    timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                    test: true
                });
                
                // Delete test doc
                await testDoc.delete();
                
                statusDiv.innerHTML = '<span class="success">‚úÖ Connection successful!</span>';
                log('Connection test passed!', 'success');
            } catch (error) {
                statusDiv.innerHTML = '<span class="error">‚ùå Connection failed: ' + error.message + '</span>';
                log('Connection test failed: ' + error.message, 'error');
            }
        }

        // Test write permissions
        async function testWrite() {
            log('Testing write permissions...', 'info');
            const testDiv = document.getElementById('rules-test');
            
            try {
                const docRef = await db.collection('scans').add({
                    test: true,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                    date: new Date().toISOString()
                });
                
                testDiv.innerHTML += '<br><span class="success">‚úÖ Write test passed! Doc ID: ' + docRef.id + '</span>';
                log('Write test successful! Doc ID: ' + docRef.id, 'success');
            } catch (error) {
                testDiv.innerHTML += '<br><span class="error">‚ùå Write failed: ' + error.message + '</span>';
                log('Write test failed: ' + error.message, 'error');
                log('Error code: ' + error.code, 'error');
            }
        }

        // Test read permissions
        async function testRead() {
            log('Testing read permissions...', 'info');
            const testDiv = document.getElementById('rules-test');
            
            try {
                const snapshot = await db.collection('scans').limit(1).get();
                testDiv.innerHTML += '<br><span class="success">‚úÖ Read test passed! Found ' + snapshot.size + ' documents</span>';
                log('Read test successful! Found ' + snapshot.size + ' documents', 'success');
            } catch (error) {
                testDiv.innerHTML += '<br><span class="error">‚ùå Read failed: ' + error.message + '</span>';
                log('Read test failed: ' + error.message, 'error');
            }
        }

        // Load current statistics
        async function loadStats() {
            log('Loading statistics...', 'info');
            const statsDiv = document.getElementById('current-stats');
            
            try {
                const statsRef = db.collection('statistics').doc('summary');
                const doc = await statsRef.get();
                
                if (doc.exists) {
                    const data = doc.data();
                    statsDiv.innerHTML = '<pre>' + JSON.stringify(data, null, 2) + '</pre>';
                    log('Statistics loaded successfully', 'success');
                } else {
                    statsDiv.innerHTML = '<span class="warning">No statistics document found</span>';
                    log('No statistics document exists yet', 'warning');
                }
            } catch (error) {
                statsDiv.innerHTML = '<span class="error">‚ùå Error: ' + error.message + '</span>';
                log('Failed to load statistics: ' + error.message, 'error');
            }
        }

        // Simulate a scan completion
        async function simulateScan() {
            log('Simulating scan completion...', 'info');
            const resultDiv = document.getElementById('simulate-result');
            
            const testData = {
                primaryTalent: 'digitaal',
                scores: {
                    creatief: 3,
                    digitaal: 8,
                    onderzoekend: 5,
                    sociaal: 4
                },
                answers: [0, 1, 2, 3, 0, 1, 2, 3, 0, 1]
            };
            
            try {
                // Save scan
                log('Saving scan data...', 'info');
                const scanRef = await db.collection('scans').add({
                    ...testData,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                    date: new Date().toISOString()
                });
                
                log('Scan saved with ID: ' + scanRef.id, 'success');
                
                // Update statistics
                log('Updating statistics...', 'info');
                const statsRef = db.collection('statistics').doc('summary');
                const doc = await statsRef.get();
                
                if (!doc.exists) {
                    log('Creating new statistics document...', 'info');
                    await statsRef.set({
                        totalScans: 1,
                        talentCounts: {
                            [testData.primaryTalent]: 1
                        },
                        lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
                    });
                } else {
                    log('Updating existing statistics...', 'info');
                    await statsRef.update({
                        totalScans: firebase.firestore.FieldValue.increment(1),
                        [`talentCounts.${testData.primaryTalent}`]: firebase.firestore.FieldValue.increment(1),
                        lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
                    });
                }
                
                resultDiv.innerHTML = '<span class="success">‚úÖ Scan simulation successful!</span>';
                log('Scan simulation completed successfully!', 'success');
                
                // Auto-load stats to show the update
                setTimeout(loadStats, 500);
                
            } catch (error) {
                resultDiv.innerHTML = '<span class="error">‚ùå Error: ' + error.message + '</span>';
                log('Scan simulation failed: ' + error.message, 'error');
                log('Error details: ' + JSON.stringify(error), 'error');
            }
        }

        // Auto-test on load
        window.addEventListener('load', () => {
            setTimeout(testConnection, 1000);
        });
    </script>
</body>
</html>